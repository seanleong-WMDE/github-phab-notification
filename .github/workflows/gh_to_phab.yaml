name: GH to Phabricator

on:
  pull_request:
    types: [opened, closed]

jobs:
  phabricator_comment:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Post to Phabricator when pull request is opened or closed
      run: |
        message="${{ github.actor }} ${{ github.event.action }} ${{ github.event.pull_request._links.html.href }}"
        task=$(curl ${{ github.event.pull_request._links.commits.href }} | jq .[0].commit.message -r | grep "^Bug: T[0-9]*$" | head -1 | awk '{print $2}')

        if [ -n "${task}" ]; then
          curl https://phabricator.wikimedia.org/api/maniphest.edit \
            -d api.token=${{ secrets. }} \
            -d transactions[0][type]=comment \
            -d transactions[0][value]="${message}" \
            -d objectIdentifier=${task}